<!DOCTYPE html>
<html>

<!-- 
TODOS:
To do the 'best fit' function, I think loop through each candidate, divide the
larger by the smaller, and "floor" it, then remultiplyl that nad get the
difference between the floor andthe full multipliers.
Not sure how to handle it if the candidate is smaller but I can work it out.


 -->

<head>
    <title>The Truly Universal Converter</title>
    <meta charset="UTF-8" />
    <script src="numtowords.js"></script>
    <script src="tucVolume.js"></script>
    <script src="tucArea.js"></script>
    <script src="tucCapacity.js"></script>
    <script src="tucLength.js"></script>
    <script>
        // Global array to hold the loaded CSV data
        let tucData = [];







        // Function to load the CSV file
        function loadCSV(tucDataset, callback) {
            const fileInput = document.createElement("input");
            fileInput.type = "file";

            // Create a new File object
            var myFile;
            myFile = new File([tucDataset], 'tucdata.csv', {
                type: 'text/plain',
                lastModified: new Date(),
            });

            // Now let's create a DataTransfer to get a FileList
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(myFile);
            fileInput.files = dataTransfer.files;

            //fileInput.addEventListener("change", function (event) {
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const contents = e.target.result;
                processData(contents, callback);
            };

            reader.readAsText(file);
            //});

            //fileInput.click();
        }

        // Function to process the loaded CSV data
        function processData(csvContent, callback) {
            const lines = csvContent.split("\n");
            tucData = lines.map((line) => {
                const values = line.split(",");
                const stringValue = values[0].trim();
                const numberValue = Number(values[1].trim());
                const commentValue = values[2] === undefined ? "" : values[2].trim();
                return { string: stringValue, number: numberValue, comment: commentValue };
            });
            let tuc2 = tucData.sort(
                (p1, p2) => (p1.string > p2.string) ? 1 : (p1.string < p2.string) ? -1 : 0);
            populateDropdowns();

            callback();
        }

        // Function to populate the dropdowns with the strings from tucData
        function populateDropdowns() {
            const dropdown1 = document.getElementById("dropdown1");
            const dropdown2 = document.getElementById("dropdown2");

            dropdown1.innerHTML = '';
            dropdown2.innerHTML = '';
            tucData.forEach((item) => {
                const option1 = document.createElement("option");
                option1.value = item.string;
                option1.text = item.string;
                dropdown1.appendChild(option1);

                const option2 = document.createElement("option");
                option2.value = item.string;
                option2.text = item.string;
                dropdown2.appendChild(option2);
            });

            document.getElementById("numberInput").value = '1';

            // TODO: replace this with async call
            if (document.getElementById("ddlMeasurement").value === "length") {
                dropdown1.value = 'Empire State Building';
                dropdown2.value = 'Banana';
            }
            else {
                dropdown1.selectedIndex = 0;
                dropdown2.selectedIndex = 1;
            }
        }

        function showComment(value, commentControl) {
            const tucEntry = tucData.find(
                (item) => item.string === value
            );
            commentctl = document.getElementById(commentControl);
            commentctl.innerHTML = tucEntry.comment;
        }

        // Function to perform the calculation and display the result
        function calculate() {
            const numberInput = document.getElementById("numberInput").value;
            const dropdown1 = document.getElementById("dropdown1");
            const selectedString1 =
                dropdown1.options[dropdown1.selectedIndex].value;
            const dropdown2 = document.getElementById("dropdown2");
            const selectedString2 =
                dropdown2.options[dropdown2.selectedIndex].value;

            const selectedData1 = tucData.find(
                (item) => item.string === selectedString1
            );
            const selectedData2 = tucData.find(
                (item) => item.string === selectedString2
            );

            const c = Number(numberInput);
            const d = selectedData1.number;
            const m = selectedData2.number;

            const result = (c * d) / m;
            // if < 1, can trim down to 20 decimal places but no trialing zeros
            // this is for super small numbers, e.g., 5e-8, which cannot be word-parsed properly.
            var resultString = result.toFixed(20).replace(/(\.\d*?[1-9])0+$/g, "$1");
            if (result >= 1.0) resultString = result; // if 1 or above, just use regular string 
            const resultWords = toWords(resultString);
            if (result >= 1000) resultString = addCommas(resultString);
            const useWords = (!resultWords.startsWith("too") && !resultWords.startsWith("not")); // was unable to parse
            const resultElement = document.getElementById("result");
            resultElement.textContent = useWords
                ? `Result: ${c} ${selectedString1}(s) = ${resultWords} (${resultString}) ${selectedString2}(s)`
                : `Result: ${c} ${selectedString1}(s) = ${resultString} ${selectedString2}(s)`;
        }


        function startUp() {
            // Event listener for the Calculate button
            const calculateButton = document.getElementById("calculateButton");
            calculateButton.addEventListener("click", calculate);
            loadCSV(tucLength, function () {
                dropdown1.value = 'Empire State Building';
                dropdown2.value = 'Banana';
            });
        }

        function changeMeasurement(measurement) {
            switch (measurement) {
                case 'length':
                    loadCSV(tucLength, function () {
                        dropdown1.value = 'Empire State Building';
                        dropdown2.value = 'Banana';
                    });
                    break;
                case 'volume':
                    loadCSV(tucVolume, function () {
                        dropdown1.selectedIndex = 0;
                        dropdown2.selectedIndex = 1;
                    });
                    break;
                case 'area':
                    loadCSV(tucArea, function () {
                        dropdown1.selectedIndex = 0;
                        dropdown2.selectedIndex = 1;
                    });
                    break;
                case 'capacity':
                    loadCSV(tucCapacity, function () {
                        dropdown1.selectedIndex = 0;
                        dropdown2.selectedIndex = 1;
                    });
                    break;
            }
        }



    </script>
</head>

<body onload="javascript:startUp()">
    <div id="app"></div>

    <h1>The Truly Universal Converter</h1>
    <p />
    <h3>Dedicated to the Great American People, who apparently will use <i>anything</i> for measurement other than the
        metric system.</h3>
    <br />
    <label for="ddlMeasurement">Select a measurement:</label>
    <select id="ddlMeasurement" onchange="changeMeasurement(this.value)">
        <option value="length">Length</option>
        <option value="area">Area</option>
        <option value="volume">Volume</option>
        <option value="capacity">Data Capacity</option>
    </select>
    <br />
    <label for="numberInput">Enter a unit to convert:</label>
    <input type="number" id="numberInput" />
    <br />
    <label for="dropdown1">Base unit:</label>
    <select id="dropdown1" onchange="showComment(this.value, 'comment1');"></select>
    &nbsp;
    <label id="comment1"></label>
    <br />
    <label for="dropdown2">New unit:</label>
    <select id="dropdown2" onchange="showComment(this.value, 'comment2');"></select>
    &nbsp;
    <label id="comment2"></label>
    <br />
    <button id="calculateButton">Calculate</button>
    <p id="result"></p>
</body>

</html>